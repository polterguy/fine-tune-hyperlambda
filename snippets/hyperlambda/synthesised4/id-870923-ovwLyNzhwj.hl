
// This Hyperlambda code connects to a database and checks if a user exists based on the provided username. If the user exists, it changes the user's password using the [magic.auth.change-password] slot. If the user does not exist, it creates a new user with the specified username, password, and roles using the [magic.auth.create-user] slot. Afterward, it creates a new JWT token for the user with the [auth.ticket.create] slot and returns the token as the result.
data.connect:[generic|magic]
   data.read
      table:users
      where
         and
            username.eq:x:@.arguments/*/username
   if
      exists:x:@data.read/*/*
      .lambda
         execute:magic.auth.change-password
            password:x:@.arguments/*/password
            is_hashed:x:@.arguments/*/is_hashed
   else
      execute:magic.auth.create-user
         username:x:@.arguments/*/username
         password:x:@.arguments/*/password
         is_hashed:x:@.arguments/*/is_hashed
         roles
            .:root
         extra
            email:x:@.arguments/*/email
            name:x:@.arguments/*/name
   auth.ticket.create
      username:x:@.arguments/*/username
      roles
         .:root
   yield
      ticket:x:@auth.ticket.create
