
// This Hyperlambda code defines a dynamic slot [magic.db.mssql.columns] that retrieves column metadata for a specified table in a SQL Server database. It checks for a connection string and constructs a connection identifier. The slot connects to the database, executes a SQL query to retrieve column details, processes each column's metadata, maps SQL types to Hyperlambda types, and returns the processed metadata. Key slots include [slots.create] for defining the slot, [mssql.connect] for database connection, [mssql.select] for executing the SQL query, and [switch] for type mapping.
hyper2lambda
   slots.create:magic.db.mssql.columns
      validators.mandatory:x:@.arguments/*/database
      validators.mandatory:x:@.arguments/*/table
      .connection:[master]
      if
         and
            not
               eq
                  get-value:x:@.arguments/*/connection-string
                  .
            not
               eq
                  get-value:x:@.arguments/*/connection-string
                  .:
         .lambda
            set-value:x:@.connection
               strings.concat
                  .:[
                  get-value:x:@.arguments/*/connection-string
                  .:|
                  get-value:x:@.arguments/*/database
                  .:]
      else
         set-value:x:@.connection
            strings.concat
               .:[generic|
               get-value:x:@.arguments/*/database
               .:]
      mssql.connect:x:@.connection
         mssql.select:"select c.name 'name', t.Name 'type', c.is_nullable 'nullable', isnull(i.is_primary_key, 0) 'primary', c.is_identity 'automatic', c.default_object_id 'default'\n         from sys.columns c \n             inner join sys.types t on c.user_type_id = t.user_type_id\n             left outer join sys.index_columns ic \n             left outer join sys.indexes i on ic.object_id = i.object_id and \n                 ic.index_id = i.index_id on ic.object_id = c.object_id and \n                 ic.column_id = c.column_id and i.is_primary_key = 1\n         where c.object_id = OBJECT_ID(@table)"
            @table:x:@.arguments/*/table
         for-each:x:@mssql.select/*
            unwrap:x:+/*/*
            .tmp
               ""
                  name:x:@.dp/#/*/name
                  db:x:@.dp/#/*/type
                  nullable:x:@.dp/#/*/nullable
                  primary:x:@.dp/#/*/primary
                  automatic:x:@.dp/#/*/automatic
            if
               mt
                  get-value:x:@.dp/#/*/default
                  .:int:0
               .lambda
                  set-value:x:@.tmp/*/*/automatic
                     .:bool:true
            .type
            switch:x:@.dp/#/*/type
               case:date
               case:datetime
               case:datetime2
               case:datetimeoffset
               case:smalldatetime
               case:time
                  set-value:x:@.type
                     .:date
               case:numeric
               case:decimal
               case:smallmoney
               case:money
               case:float
               case:real
                  set-value:x:@.type
                     .:decimal
               case:bigint
               case:smallint
               case:int
               case:tinyint
                  set-value:x:@.type
                     .:long
               case:bit
                  set-value:x:@.type
                     .:bool
               case:char
               case:varchar
               case:text
               case:nchar
               case:nvarchar
               case:ntext
               case:binary
               case:image
               case:varbinary
               case:uniqueidentifier
                  set-value:x:@.type
                     .:string
               case:rowversion
               case:timestamp
                  set-value:x:@.type
                     .:string
                  set-value:x:@.tmp/*/*/automatic
                     .:bool:true
               default
                  set-value:x:@.type
                     .:string
            unwrap:x:+/*/*
            add:x:@.tmp/*
               .
                  hl:x:@.type
            add:x:../*/mssql.connect/*/return-nodes
               get-nodes:x:@.tmp/*
         return-nodes
